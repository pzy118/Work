<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ•°æ®åº“è®¾ç½®</title>
    <style>
        * { margin: 0; padding: 0; font-family: å¾®è½¯é›…é»‘; }
        body { padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .sql-box { 
            background: #f5f5f5; 
            border: 1px solid #ddd; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button { 
            background: #27ae60; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px;
            margin: 10px 5px;
        }
        button:hover { background: #2ecc71; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .step { 
            margin: 20px 0; 
            padding: 15px; 
            border-left: 4px solid #3498db; 
            background: #f8f9fa; 
        }
        .copy-btn { background: #3498db; font-size: 12px; padding: 5px 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>è§‚å½±æ¸…å•æ•°æ®åº“è®¾ç½®</h1>
        
        <div class="step">
            <h3>ğŸ“‹ æ­¥éª¤è¯´æ˜</h3>
            <p>1. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶å®Œæ•´çš„SQLè„šæœ¬</p>
            <p>2. æ‰“å¼€ä½ çš„Supabaseé¡¹ç›®æ§åˆ¶å°</p>
            <p>3. è¿›å…¥SQLç¼–è¾‘å™¨é¡µé¢</p>
            <p>4. ç²˜è´´SQLè„šæœ¬å¹¶æ‰§è¡Œ</p>
            <p>5. è¿”å›ä¸»é¡µé¢æµ‹è¯•åº”ç”¨</p>
        </div>

        <button onclick="copySQL()" class="copy-btn">ğŸ“‹ å¤åˆ¶å®Œæ•´SQLè„šæœ¬</button>
        <button onclick="executeSQL()" class="danger">ğŸš€ ç›´æ¥æ‰§è¡ŒSQLï¼ˆéœ€è¦åœ¨Supabaseç¯å¢ƒä¸­ï¼‰</button>

        <div class="sql-box" id="sqlContent">-- ========================================
-- è§‚å½±æ¸…å•æ•°æ®åº“è®¾ç½®è„šæœ¬
-- ========================================

-- åˆ é™¤ç°æœ‰çš„è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP TABLE IF EXISTS movie_categories CASCADE;
DROP TABLE IF EXISTS movies CASCADE;
DROP TABLE IF EXISTS categories CASCADE;

-- åˆ›å»ºåˆ†ç±»è¡¨
CREATE TABLE categories (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç”µå½±è¡¨
CREATE TABLE movies (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    rating DECIMAL(3,1) CHECK (rating >= 0 AND rating <= 10),
    comment TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç”µå½±åˆ†ç±»å…³è”è¡¨
CREATE TABLE movie_categories (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    movie_id UUID REFERENCES movies(id) ON DELETE CASCADE,
    category_id UUID REFERENCES categories(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(movie_id, category_id) -- é˜²æ­¢é‡å¤å…³è”
);

-- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_movie_categories_movie_id ON movie_categories(movie_id);
CREATE INDEX idx_movie_categories_category_id ON movie_categories(category_id);

-- æ’å…¥ç¤ºä¾‹åˆ†ç±»æ•°æ®
INSERT INTO categories (name) VALUES 
('åŠ¨ä½œç‰‡'),
('å–œå‰§ç‰‡'),
('çˆ±æƒ…ç‰‡'),
('ç§‘å¹»ç‰‡'),
('ææ€–ç‰‡'),
('åŠ¨ç”»ç‰‡');

-- æ’å…¥ç¤ºä¾‹ç”µå½±æ•°æ®
INSERT INTO movies (title, rating, comment) VALUES 
('å¤ä»‡è€…è”ç›Ÿ4', 8.5, 'å²è¯—çº§çš„è¶…çº§è‹±é›„ç”µå½±ï¼Œåå¹´å¸ƒå±€çš„å®Œç¾æ”¶å®˜'),
('æ³°å¦å°¼å…‹å·', 9.0, 'ç»å…¸çˆ±æƒ…ç”µå½±ï¼Œæ°¸æ’çš„ç»å…¸'),
('åƒä¸åƒå¯»', 9.2, 'å®«å´éªçš„æ°ä½œï¼Œå……æ»¡æƒ³è±¡åŠ›çš„ä¸–ç•Œ'),
('ç›—æ¢¦ç©ºé—´', 8.8, 'è¯ºå…°çš„çƒ§è„‘ç¥ä½œï¼Œå±‚å±‚æ¢¦å¢ƒ');

-- ä¸ºç¤ºä¾‹ç”µå½±æ·»åŠ åˆ†ç±»å…³è”
INSERT INTO movie_categories (movie_id, category_id) 
SELECT 
    (SELECT id FROM movies WHERE title = 'å¤ä»‡è€…è”ç›Ÿ4'),
    (SELECT id FROM categories WHERE name = 'åŠ¨ä½œç‰‡');

INSERT INTO movie_categories (movie_id, category_id) 
SELECT 
    (SELECT id FROM movies WHERE title = 'å¤ä»‡è€…è”ç›Ÿ4'),
    (SELECT id FROM categories WHERE name = 'ç§‘å¹»ç‰‡');

INSERT INTO movie_categories (movie_id, category_id) 
SELECT 
    (SELECT id FROM movies WHERE title = 'æ³°å¦å°¼å…‹å·'),
    (SELECT id FROM categories WHERE name = 'çˆ±æƒ…ç‰‡');

INSERT INTO movie_categories (movie_id, category_id) 
SELECT 
    (SELECT id FROM movies WHERE title = 'åƒä¸åƒå¯»'),
    (SELECT id FROM categories WHERE name = 'åŠ¨ç”»ç‰‡');

INSERT INTO movie_categories (movie_id, category_id) 
SELECT 
    (SELECT id FROM movies WHERE title = 'ç›—æ¢¦ç©ºé—´'),
    (SELECT id FROM categories WHERE name = 'ç§‘å¹»ç‰‡');

-- æŸ¥çœ‹è®¾ç½®ç»“æœ
SELECT 'Categories count: ' || COUNT(*) FROM categories;
SELECT 'Movies count: ' || COUNT(*) FROM movies;
SELECT 'Movie-Categories relations count: ' || COUNT(*) FROM movie_categories;

SELECT 
    m.title,
    m.rating,
    STRING_AGG(c.name, 'ã€') as categories
FROM movies m
LEFT JOIN movie_categories mc ON m.id = mc.movie_id
LEFT JOIN categories c ON mc.category_id = c.id
GROUP BY m.id, m.title, m.rating
ORDER BY m.created_at DESC;</div>

        <div id="status"></div>

        <div class="step">
            <h3>ğŸ¯ è®¾ç½®å®Œæˆå</h3>
            <p>æ‰§è¡Œå®ŒSQLè„šæœ¬åï¼Œç‚¹å‡»ä¸‹æ–¹é“¾æ¥æµ‹è¯•åº”ç”¨ï¼š</p>
            <a href="index.html">ğŸ¬ è§‚å½±æ¸…å•ä¸»é¡µ</a> |
            <a href="add.html">â• æ·»åŠ è§‚å½±è®°å½•</a> |
            <a href="category.html">ğŸ“‚ åˆ†ç±»ç®¡ç†</a>
        </div>

        <div class="step">
            <h3>ğŸ“ è¡¨ç»“æ„è¯´æ˜</h3>
            <ul>
                <li><strong>categories</strong>: åˆ†ç±»è¡¨ï¼Œå­˜å‚¨ç”µå½±åˆ†ç±»</li>
                <li><strong>movies</strong>: ç”µå½±è¡¨ï¼Œå­˜å‚¨è§‚å½±è®°å½•</li>
                <li><strong>movie_categories</strong>: å…³è”è¡¨ï¼Œè¿æ¥ç”µå½±å’Œåˆ†ç±»</li>
            </ul>
            <p>âœ… å·²é…ç½®æ­£ç¡®çš„å¤–é”®å…³ç³»å’Œçº§è”åˆ é™¤</p>
            <p>âœ… åŒ…å«ç¤ºä¾‹æ•°æ®ç”¨äºæµ‹è¯•</p>
        </div>
    </div>

    <!-- å¼•å…¥Supabase CDNå’Œé…ç½®æ–‡ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="supabaseClient.js"></script>
    <script>
        // å¤åˆ¶SQLåˆ°å‰ªè´´æ¿
        function copySQL() {
            const sqlContent = document.getElementById('sqlContent').textContent;
            navigator.clipboard.writeText(sqlContent).then(() => {
                showStatus('âœ… SQLè„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            }).catch(() => {
                showStatus('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å°è¯•ç›´æ¥æ‰§è¡ŒSQLï¼ˆåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­å¯èƒ½å—é™ï¼‰
        async function executeSQL() {
            showStatus('âš ï¸ æ³¨æ„ï¼šç›´æ¥æ‰§è¡ŒåŠŸèƒ½éœ€è¦åœ¨Supabaseç¯å¢ƒä¸­è¿è¡Œ', 'warning');
            
            try {
                // è¿™é‡Œå¯ä»¥å°è¯•é€æ¡æ‰§è¡ŒSQLï¼Œä½†ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶å¯èƒ½æ— æ³•ç›´æ¥æ‰§è¡Œ
                const sqlStatements = document.getElementById('sqlContent').textContent
                    .split('--')
                    .filter(stmt => stmt.trim())
                    .map(stmt => '--' + stmt.trim());

                showStatus('ğŸ’¡ å»ºè®®å¤åˆ¶SQLè„šæœ¬åˆ°Supabaseæ§åˆ¶å°æ‰§è¡Œ', 'warning');
            } catch (error) {
                showStatus('âŒ æ‰§è¡Œå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
        window.onload = function() {
            showStatus('ğŸ‘‹ æ¬¢è¿ï¼è¯·æŒ‰ç…§æ­¥éª¤è¯´æ˜è®¾ç½®æ•°æ®åº“', 'success');
        };
    </script>
</body>
</html>